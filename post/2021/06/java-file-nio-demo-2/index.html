<!doctype html><html><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/g.nereusyi.com\/"},"articleSection":"post","name":"Java NIO File API 使用总结 2","headline":"Java NIO File API 使用总结 2","description":"在之前的文章中总结了NIO的Path接口和Files工具类的使用，本文继续总结一些其他的新功能和概念","inLanguage":"en","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2021","datePublished":"2021-06-20 18:49:11 \u002b0800 CST","dateModified":"2021-06-20 18:49:11 \u002b0800 CST","url":"https:\/\/g.nereusyi.com\/post\/2021\/06\/java-file-nio-demo-2\/","wordCount":"345","keywords":["java","Blog"]}</script><meta charset=utf-8><title>Java NIO File API 使用总结 2 - NereusYi</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.81.0"><meta name=description content="在之前的文章中总结了NIO的Path接口和Files工具类的使用，本文继续总结一些其他的新功能和概念"><meta name=twitter:card content="summary"><meta name=twitter:title content="Java NIO File API 使用总结 2"><meta name=twitter:description content="在之前的文章中总结了NIO的Path接口和Files工具类的使用，本文继续总结一些其他的新功能和概念"><meta property="og:title" content="Java NIO File API 使用总结 2"><meta property="og:description" content="在之前的文章中总结了NIO的Path接口和Files工具类的使用，本文继续总结一些其他的新功能和概念"><meta property="og:type" content="article"><meta property="og:url" content="https://g.nereusyi.com/post/2021/06/java-file-nio-demo-2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-06-20T18:49:11+08:00"><meta property="article:modified_time" content="2021-06-20T18:49:11+08:00"><meta property="og:image" content="https://g.nereusyi.com//images/logo.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="512"><meta property="og:image:height" content="512"><meta content="java,nio2" name=keywords><meta itemprop=name content="Java NIO File API 使用总结 2"><meta itemprop=description content="在之前的文章中总结了NIO的Path接口和Files工具类的使用，本文继续总结一些其他的新功能和概念"><meta itemprop=datePublished content="2021-06-20T18:49:11+08:00"><meta itemprop=dateModified content="2021-06-20T18:49:11+08:00"><meta itemprop=wordCount content="345"><meta itemprop=keywords content="java,"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css><link rel=stylesheet href=https://g.nereusyi.com/css/main.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css><link href=//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css rel=stylesheet type=text/css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-140619403-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-140619403-1')</script><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?cad0d60e6cbf96c36edba25513ef42db",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script></head><body><div id=wrapper><header id=header><h1><a href=https://g.nereusyi.com/>Nereus</a></h1><nav class=links><ul><li><a href=https://g.nereusyi.com/post/><i class="fa fa-home">&nbsp;</i>Home</a></li><li><a href=https://g.nereusyi.com/post/><i class="fa fa-newspaper-o">&nbsp;</i>Blog</a></li><li><a href=https://g.nereusyi.com/categories/><i class="fa fa-sitemap">&nbsp;</i>Categories</a></li><li><a href=https://g.nereusyi.com/about/><i class="fa fa-id-card-o">&nbsp;</i>About</a></li></ul></nav><nav class=main><ul><li id=share-nav class=share-menu style=display:none><a class=fa-share-alt href=#share-menu>Share</a></li><li class=search><a class=fa-search href=#search>Search</a><form id=search method=get action=//google.com/search><input type=text name=q placeholder=Search>
<input type=hidden name=as_sitesearch value=https://g.nereusyi.com/></form></li><li class=menu><a class=fa-bars href=#menu>Menu</a></li></ul></nav></header><section id=menu><section><form class=search method=get action=//google.com/search><input type=text name=q placeholder=Search>
<input type=hidden name=as_sitesearch value=https://g.nereusyi.com/></form></section><section><ul class=links><li><a href=https://g.nereusyi.com/post/><h3><i class="fa fa-home">&nbsp;</i>Home</h3></a></li><li><a href=https://g.nereusyi.com/post/><h3><i class="fa fa-newspaper-o">&nbsp;</i>Blog</h3></a></li><li><a href=https://g.nereusyi.com/categories/><h3><i class="fa fa-sitemap">&nbsp;</i>Categories</h3></a></li><li><a href=https://g.nereusyi.com/about/><h3><i class="fa fa-id-card-o">&nbsp;</i>About</h3></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><article class=mini-post><header><h3><a href=https://g.nereusyi.com/post/>Post</a></h3><time class=published datetime=2021-08-29>August 29, 2021</time></header></article><article class=mini-post><header><h3><a href=https://g.nereusyi.com/post/2021/08/enhance-jvm-8-and-11-with-npe/>增强Java8和11的空指针异常提示</a></h3><time class=published datetime=2021-08-29>August 29, 2021</time></header></article><a href=/post/ class=button>View more posts</a></div></section></section><section id=share-menu><section id=social-share-nav><ul class=links><header><h3>Share this post <i class="fa fa-smile-o"></i></h3></header><li><a href="//twitter.com/share?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&text=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202&via=" target=_blank class="share-btn twitter"><i class="fa fa-twitter"></i><p>Twitter</p></a></li><li><a href="//plus.google.com/share?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f" target=_blank class="share-btn google-plus"><i class="fa fa-google-plus"></i><p>Google+</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f" target=_blank class="share-btn facebook"><i class="fa fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&title=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn reddit"><i class="fa fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&title=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn linkedin"><i class="fa fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&title=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn stumbleupon"><i class="fa fa-stumbleupon"></i><p>StumbleUpon</p></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&description=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn pinterest"><i class="fa fa-pinterest-p"></i><p>Pinterest</p></a></li><li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f" target=_blank class="share-btn email"><i class="fa fa-envelope"></i><p>Email</p></a></li></ul></section></section><div id=main><article class=post><header><div class=title><h1><a href=https://g.nereusyi.com/post/2021/06/java-file-nio-demo-2/>Java NIO File API 使用总结 2</a></h1><p>在之前的文章中总结了NIO的Path接口和Files工具类的使用，本文继续总结一些其他的新功能和概念</p></div><div class=meta><time class=published datetime=2021-06-20>June 20, 2021</time>
<span class=author></span><p>2 minute read</p></div></header><section id=social-share><ul class=icons><li><a href="//twitter.com/share?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&text=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202&via=" target=_blank class="share-btn twitter"><i class="fa fa-twitter"></i><p>Twitter</p></a></li><li><a href="//plus.google.com/share?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f" target=_blank class="share-btn google-plus"><i class="fa fa-google-plus"></i><p>Google+</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f" target=_blank class="share-btn facebook"><i class="fa fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&title=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn reddit"><i class="fa fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&title=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn linkedin"><i class="fa fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&title=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn stumbleupon"><i class="fa fa-stumbleupon"></i><p>StumbleUpon</p></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f&description=Java%20NIO%20File%20API%20%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%202" target=_blank class="share-btn pinterest"><i class="fa fa-pinterest-p"></i><p>Pinterest</p></a></li><li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fg.nereusyi.com%2fpost%2f2021%2f06%2fjava-file-nio-demo-2%2f" target=_blank class="share-btn email"><i class="fa fa-envelope"></i><p>Email</p></a></li></ul></section><div id=content><h1 id=简介>简介</h1><p>在之前的文章中总结了NIO的Path接口和Files工具类的使用，本文继续总结一些其他的新功能和概念</p><h1 id=nio的基础概念和基本使用>NIO的基础概念和基本使用</h1><p>不同于传统的Java File I/O的Stream流的概念，NIO基于Buffer和Channel重新设计了一套API。Buffer的API相对来说比较难用，不过具有零拷贝的功能，可以大大提高文件传输速度。</p><h2 id=创建和写入文件>创建和写入文件</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createAndWriteFile</span><span style=color:#f92672>(){</span>
    ByteBuffer byteBuffer <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>allocate</span><span style=color:#f92672>(</span>1024<span style=color:#f92672>);</span>
    byteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HelloWorld&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>StandardCharsets<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>));</span>
    byteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>flip</span><span style=color:#f92672>();</span>
    <span style=color:#66d9ef>try</span> <span style=color:#f92672>(</span> FileChannel fileChannel <span style=color:#f92672>=</span> FileChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>open</span><span style=color:#f92672>(</span>Path<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/tmp/test.txt&#34;</span><span style=color:#f92672>),</span>
            StandardOpenOption<span style=color:#f92672>.</span><span style=color:#a6e22e>CREATE</span><span style=color:#f92672>,</span>StandardOpenOption<span style=color:#f92672>.</span><span style=color:#a6e22e>WRITE</span><span style=color:#f92672>)</span> <span style=color:#f92672>){</span>    
        fileChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>byteBuffer<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;write success.&#34;</span><span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>可以看到，NIO写入文件前，需要先创建ByteBuffer对象，之后再往里面写入数据。写入之后必须调用<code>flip</code>方法重新设置position和limit，这也是Buffer中的概念。</p><p>之后再创建一个Channel，往Channel中写入数据。</p><h2 id=读取文件>读取文件</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>readFile</span><span style=color:#f92672>(){</span>
    Charset utf8 <span style=color:#f92672>=</span> StandardCharsets<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>;</span>
    ByteBuffer byteBuffer <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>allocate</span><span style=color:#f92672>(</span>1024<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>try</span> <span style=color:#f92672>(</span> FileChannel fileChannel <span style=color:#f92672>=</span> FileChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>open</span><span style=color:#f92672>(</span>Path<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/tmp/test.txt&#34;</span><span style=color:#f92672>),</span>
            StandardOpenOption<span style=color:#f92672>.</span><span style=color:#a6e22e>READ</span><span style=color:#f92672>)</span> <span style=color:#f92672>){</span>
        fileChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>byteBuffer<span style=color:#f92672>);</span>
        byteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>flip</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
    CharBuffer charBuffer <span style=color:#f92672>=</span> utf8<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>byteBuffer<span style=color:#f92672>);</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>print</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;read result:&#34;</span><span style=color:#f92672>);</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> String<span style=color:#f92672>(</span>charBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>array</span><span style=color:#f92672>()));</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>可以看到读取文件也是类似，先创建ByteBuffer对象再读取数据，读取完之后再调用<code>flip</code>方法才能decode。从这里可以看到ByteBuffer确实比较难用，一不小心忘记调用<code>flip</code>，就会出现各种意想不到的BUG。</p><h1 id=file-nio的扩展>File NIO的扩展</h1><p>Java在1.7版本对NIO再次进行了扩展，使Java对文件系统的处理更接近底层，包括监听目录的变化等，通常也被叫做NIO2。</p><h2 id=filesystemproviderfilesystem和filestore>FileSystemProvider,FileSystem和FileStore</h2><p>这三个类提供了对特定文件系统更底层的支持：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>basic</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
    List<span style=color:#f92672>&lt;</span>FileSystemProvider<span style=color:#f92672>&gt;</span> providers <span style=color:#f92672>=</span> FileSystemProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>installedProviders</span><span style=color:#f92672>();</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>providers<span style=color:#f92672>);</span>
    FileSystem defaultFileSystem <span style=color:#f92672>=</span> FileSystems<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>();</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>defaultFileSystem<span style=color:#f92672>);</span>
    Iterable<span style=color:#f92672>&lt;</span>Path<span style=color:#f92672>&gt;</span> rootDirectories <span style=color:#f92672>=</span> defaultFileSystem<span style=color:#f92672>.</span><span style=color:#a6e22e>getRootDirectories</span><span style=color:#f92672>();</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>rootDirectories<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>().</span><span style=color:#a6e22e>next</span><span style=color:#f92672>());</span>
    Iterable<span style=color:#f92672>&lt;</span>FileStore<span style=color:#f92672>&gt;</span> fileStores <span style=color:#f92672>=</span> defaultFileSystem<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileStores</span><span style=color:#f92672>();</span>
    FileStore fileStore <span style=color:#f92672>=</span> fileStores<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>().</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>fileStore<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>());</span>
    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>fileStore<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>());</span>
  <span style=color:#75715e>//        defaultFileSystem.provider().createDirectory(Path.of(&#34;/tmp/testDir&#34;));
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><ul><li><code>FileSystemProvider.installedProviders()</code>可以查看支持的文件系统</li><li><code>FileSystem defaultFileSystem = FileSystems.getDefault()</code>拿到默认的文件系统</li></ul><h2 id=jarfilesystem>JarFileSystem</h2><p>FileSystem中，还提供了对Jar文件的支持，使得在Jar文件中的操作更加容易：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>jarFileSystem</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
    URI jarUri <span style=color:#f92672>=</span> URI<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;jar:file:///tmp/test.jar&#34;</span><span style=color:#f92672>);</span>

    Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> options <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
    <span style=color:#75715e>// Create
</span><span style=color:#75715e></span>    options<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;create&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>try</span><span style=color:#f92672>(</span> FileSystem jarFs <span style=color:#f92672>=</span> FileSystems<span style=color:#f92672>.</span><span style=color:#a6e22e>newFileSystem</span><span style=color:#f92672>(</span>jarUri<span style=color:#f92672>,</span> options<span style=color:#f92672>);){</span>
        <span style=color:#75715e>// Write file into jar
</span><span style=color:#75715e></span>        Path dir <span style=color:#f92672>=</span> jarFs<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;files&#34;</span><span style=color:#f92672>);</span>
        jarFs<span style=color:#f92672>.</span><span style=color:#a6e22e>provider</span><span style=color:#f92672>().</span><span style=color:#a6e22e>createDirectory</span><span style=color:#f92672>(</span>dir<span style=color:#f92672>);</span>

        Path textTxt <span style=color:#f92672>=</span> jarFs<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;files/text.txt&#34;</span><span style=color:#f92672>);</span>
        Files<span style=color:#f92672>.</span><span style=color:#a6e22e>writeString</span><span style=color:#f92672>(</span>textTxt<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;HelloWorld Jar File&#34;</span><span style=color:#f92672>,</span> StandardCharsets<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>,</span>
                StandardOpenOption<span style=color:#f92672>.</span><span style=color:#a6e22e>CREATE</span><span style=color:#f92672>,</span> StandardOpenOption<span style=color:#f92672>.</span><span style=color:#a6e22e>WRITE</span><span style=color:#f92672>);</span>

        <span style=color:#75715e>// Read file in jar
</span><span style=color:#75715e></span>        Path path <span style=color:#f92672>=</span> jarFs<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;files/text.txt&#34;</span><span style=color:#f92672>);</span>
        String result <span style=color:#f92672>=</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>readString</span><span style=color:#f92672>(</span>path<span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>result<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><p>常见的创建、写入文件和读取文件示例。</p><h2 id=文件系统事件监听>文件系统事件监听</h2><p>在1.7之前的Java中，如果要知道目录或文件是不是有改动，需要不断的主动查询这些目录或文件的状态。</p><p>现在NIO2对文件系统事件的监听也有了支持：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>watchEvent</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
    Path watchPath <span style=color:#f92672>=</span> Path<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/tmp&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>try</span> <span style=color:#f92672>(</span>FileSystem fileSystem <span style=color:#f92672>=</span> FileSystems<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>();</span>
         WatchService watchService <span style=color:#f92672>=</span> fileSystem<span style=color:#f92672>.</span><span style=color:#a6e22e>newWatchService</span><span style=color:#f92672>();)</span> <span style=color:#f92672>{</span>

        <span style=color:#75715e>// only watch current dir , not include sub-dir
</span><span style=color:#75715e></span>        WatchKey key <span style=color:#f92672>=</span> watchPath<span style=color:#f92672>.</span><span style=color:#a6e22e>register</span><span style=color:#f92672>(</span>watchService<span style=color:#f92672>,</span>
                StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>ENTRY_CREATE</span><span style=color:#f92672>,</span>
                StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>ENTRY_MODIFY</span><span style=color:#f92672>,</span>
                StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>ENTRY_DELETE</span><span style=color:#f92672>,</span>
                StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>OVERFLOW</span>
        <span style=color:#f92672>);</span>

        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>key<span style=color:#f92672>.</span><span style=color:#a6e22e>isValid</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            WatchKey watchKey <span style=color:#f92672>=</span> watchService<span style=color:#f92672>.</span><span style=color:#a6e22e>take</span><span style=color:#f92672>();</span>
            List<span style=color:#f92672>&lt;</span>WatchEvent<span style=color:#f92672>&lt;?&gt;&gt;</span> watchEvents <span style=color:#f92672>=</span> watchKey<span style=color:#f92672>.</span><span style=color:#a6e22e>pollEvents</span><span style=color:#f92672>();</span>
            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>WatchEvent<span style=color:#f92672>&lt;?&gt;</span> event <span style=color:#f92672>:</span> watchEvents<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                WatchEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>Kind</span><span style=color:#f92672>&lt;?&gt;</span> kind <span style=color:#f92672>=</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>kind</span><span style=color:#f92672>();</span>
                Path context <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Path<span style=color:#f92672>)</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>context</span><span style=color:#f92672>();</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>kind <span style=color:#f92672>==</span> StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>OVERFLOW</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;event too much&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>kind <span style=color:#f92672>==</span> StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>ENTRY_CREATE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;file created , path=&#34;</span> <span style=color:#f92672>+</span> context <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,type=&#34;</span> <span style=color:#f92672>+</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>probeContentType</span><span style=color:#f92672>(</span>context<span style=color:#f92672>));</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>kind <span style=color:#f92672>==</span> StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>ENTRY_MODIFY</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;file modified , path=&#34;</span> <span style=color:#f92672>+</span> context <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,type=&#34;</span> <span style=color:#f92672>+</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>probeContentType</span><span style=color:#f92672>(</span>context<span style=color:#f92672>));</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>kind <span style=color:#f92672>==</span> StandardWatchEventKinds<span style=color:#f92672>.</span><span style=color:#a6e22e>ENTRY_DELETE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;file deleted , path=&#34;</span> <span style=color:#f92672>+</span> context <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,type=&#34;</span> <span style=color:#f92672>+</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>probeContentType</span><span style=color:#f92672>(</span>context<span style=color:#f92672>));</span>
                <span style=color:#f92672>}</span>
                <span style=color:#75715e>// reset or never get event
</span><span style=color:#75715e></span>                watchKey<span style=color:#f92672>.</span><span style=color:#a6e22e>reset</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;watch key is invalid&#34;</span><span style=color:#f92672>);</span>

    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>现在在<code>/tmp</code>下对文件的操作都会触发Event，对需要的Event进行不同的操作。</p><p>不过有几个需要注意的点：</p><ul><li><code>WatchService</code>只会对当前注册的目录进行监听，不会对子目录监听，如果需要监听子目录，需要把子目录都注册一遍</li><li><code>StandardWatchEventKinds.OVERFLOW</code>的Event表示事件丢失等情况，通常是由于事件太多，此时没有什么特别的好办法，只能日志记录一下</li><li>使用完<code>WatchKey</code>之后，需要调用<code>watchKey.reset()</code>进行重置</li><li>当目录已经不存在或者被监听取消之类的情况时，<code>key.isValid()</code>方法就会返回False</li></ul><h1 id=总结>总结</h1><p>示例代码可以在<a href=https://github.com/nereusyi/java-api-demos>Github</a>上找到。</p><h1 id=参考资料>参考资料</h1><p>[1]Oracle的Java Doc文档：https://docs.oracle.com/javase/8/docs/api/index.html</p></div><footer><ul class=stats><li class=categories><ul><i class="fa fa-folder"></i><li><a class=article-category-link href=https://g.nereusyi.com/categories/java>java</a></li></ul></li><li class=tags><ul><i class="fa fa-tags"></i><li><a class=article-category-link href=https://g.nereusyi.com/tags/java>java</a></li></ul></li></ul></footer></article><article class=post><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//nereusyi.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article><ul class="actions pagination"><li><a href=https://g.nereusyi.com/post/2021/05/spring-boot-transaction/ class="button big previous">Spring的Transaction事务管理</a></li><li><a href=https://g.nereusyi.com/post/2021/08/enhance-jvm-8-and-11-with-npe/ class="button big next">增强Java8和11的空指针异常提示</a></li></ul></div><section id=sidebar><section id=intro><a href=https://g.nereusyi.com/ class=logo><img src=https://g.nereusyi.com/img/web/logo.jpg alt=Nereus></a><header><h2>Nereus</h2><p>一名Java开发</p></header><ul class=icons><li><a href=//github.com/ivyboy target=_blank title=GitHub class="fa fa-github"></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><div class=posts-container><article class=mini-post><header><h3><a href=https://g.nereusyi.com/post/>Post</a></h3><time class=published datetime=2021-08-29>August 29, 2021</time></header></article><article class=mini-post><header><h3><a href=https://g.nereusyi.com/post/2021/08/enhance-jvm-8-and-11-with-npe/>增强Java8和11的空指针异常提示</a></h3><time class=published datetime=2021-08-29>August 29, 2021</time></header></article></div><a href=/post/ class=button>View more posts</a></div></section><section id=categories><header><h3><a href=https://g.nereusyi.com/categories/>Categories</a></h3></header><p><article><header><a href=https://g.nereusyi.com/categories/java/>java</a>
<span style=float:right>8</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/spring-boot/>spring-boot</a>
<span style=float:right>4</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/jvm/>jvm</a>
<span style=float:right>3</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/docker/>docker</a>
<span style=float:right>2</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/devops/>devops</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/example/>example</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/life/>life</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/performance/>performance</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/spring-security/>spring-security</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/springboot/>springboot</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/tool/>tool</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=https://g.nereusyi.com/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7/>小技巧</a>
<span style=float:right>1</span></header></article></p></section><section id=footer><p class=copyright>&copy; 2021
NereusYi
.
Powered by <a href=//gohugo.io target=_blank>Hugo</a>
<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc/4.0/88x31.png></a><br>This site is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p></section></section></div><a id=back-to-top href=# class="fa fa-arrow-up fa-border fa-2x"></a><script src=//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.11.0/languages/java.min.js></script><script>hljs.configure({languages:[]}),hljs.initHighlightingOnLoad()</script><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js></script><script src=https://g.nereusyi.com/js/util.js></script><script src=https://g.nereusyi.com/js/main.js></script><script src=https://g.nereusyi.com/js/backToTop.js></script><script>hljs.initHighlightingOnLoad()</script></body></html>